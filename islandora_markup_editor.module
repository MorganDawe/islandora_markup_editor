<?php
/**
 * @file
 * Handles the creation/display of islandora:markupEditorCModel objects.
 */

/**
 * Implements hook_menu().
 */
function islandora_markup_editor_menu() {
  $items['islandora/markupeditor/setup/%islandora_object'] = array(
    'title' => 'Markup Editor Setup',
    'page callback' => 'islandora_markup_editor_setup',
    'page arguments' => array(3),
    'type' => MENU_CALLBACK,
    'access callback' => 'islandora_object_access_callback',
    'access arguments' => array(ISLANDORA_VIEW_OBJECTS, 3),
  );
  $items['islandora/markupeditor/save_data/%islandora_object'] = array(
    'title' => 'Save Data',
    'page callback' => 'islandora_markup_editor_savedata',
    'page arguments' => array(3),
    'type' => MENU_CALLBACK,
    'access callback' => 'islandora_object_access_callback',
    'access arguments' => array(ISLANDORA_CRITICAL_EDITION_EDIT_WITH_CWRC_WRITER, 3),
  );
  return $items;
}

/**
 * Menu callback for the editor to persist TEI data.
 *
 * @param AbstractObject $fedora_object
 *   The fedora object
 */
function islandora_markup_editor_savedata(AbstractObject $fedora_object) {
  module_load_include('inc', 'islandora_markup_editor', 'includes/utilities');
  try {
    parse_str(file_get_contents('php://input'), $_PUT);
    // @codingStandardsIgnoreStart
    $data = $_PUT['text'];
    $cwrc = str_replace('<br>', '<br />', $data);
    // @codingStandardsIgnoreEnd
    $cwrc = str_replace('&', '&amp;', $cwrc);
    // Update ds.
    if (!isset($fedora_object["OBJ"])) {
      $obj_ds = $fedora_object->constructDatastream('OBJ', 'M');
      $fedora_object->ingestDatastream($obj_ds);
    }
    else {
      $obj_ds = $fedora_object["OBJ"];
    }
    $obj_ds->setContentFromString($cwrc);

    // Sanitize the schema URL, incase it gets managled during transport.
    $schema = html_entity_decode(stripslashes(check_plain($_PUT['schema'])), ENT_QUOTES, 'UTF-8');
    islandora_markup_editor_add_tei_processing_instruction($fedora_object, $schema);

    drupal_json_output($cwrc);
  }
  catch (Exception $e) {
    watchdog('islandora_markup_editor',
      'Failed to set OBJ datastream content for pid @pid</br>code: @code<br/>message: @msg',
      array(
        '@pid' => $fedora_object->id,
        '@code' => $e->getCode(),
        '@msg' => $e->getMessage(),
      ),
      WATCHDOG_ERROR
    );
    drupal_json_output(array("Error" => "An error occured updating "));
  }
}

/**
 * Implements hook_islandora_required_objects().
 */
function islandora_markup_editor_islandora_required_objects(IslandoraTuque $connection) {
  $module_path = drupal_get_path('module', 'islandora_markup_editor');
  // Markup Editor Content Model.
  $markup_editor_model = $connection->repository->constructObject('islandora:markupEditorCModel');
  $markup_editor_model->owner = 'fedoraAdmin';
  $markup_editor_model->label = 'Islandora Markup Editor Content Model';
  $markup_editor_model->models = 'fedora-system:ContentModel-3.0';
  // DS-COMPOSITE-MODEL Datastream.
  $datastream = $markup_editor_model->constructDatastream('DS-COMPOSITE-MODEL', 'X');
  $datastream->label = 'DS-COMPOSITE-MODEL';
  $datastream->mimetype = 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/islandora_markup_editor_ds_composite_model.xml", FALSE);
  $markup_editor_model->ingestDatastream($datastream);
  // Markup Editor Collection.
  $markup_editor_collection = $connection->repository->constructObject('islandora:markup_editor_collection');
  $markup_editor_collection->owner = 'fedoraAdmin';
  $markup_editor_collection->label = 'Markup Editor Collection';
  $markup_editor_collection->models = 'islandora:collectionCModel';
  $markup_editor_collection->relationships->add(FEDORA_RELS_EXT_URI, 'isMemberOfCollection', variable_get('islandora_repository_pid', 'islandora:root'));
  // Collection Policy Datastream.
  $datastream = $markup_editor_collection->constructDatastream('COLLECTION_POLICY', 'X');
  $datastream->label = 'Collection policy';
  $datastream->mimetype = 'text/xml';
  $datastream->setContentFromFile("$module_path/xml/islandora_markup_editor_collection_policy.xml", FALSE);
  $markup_editor_collection->ingestDatastream($datastream);
  // TN Datastream.
  $datastream = $markup_editor_collection->constructDatastream('TN', 'M');
  $datastream->label = 'Thumbnail';
  $datastream->mimetype = 'image/png';
  $datastream->setContentFromFile("$module_path/images/folder.png", FALSE);
  $markup_editor_collection->ingestDatastream($datastream);
  return array(
    'islandora_markup_editor' => array(
      'title' => 'Islandora markup editor',
      'objects' => array(
        $markup_editor_model,
        $markup_editor_collection,
      ),
    ),
  );
}

/**
 * Implements hook_islandora_xml_form_builder_forms().
 */
function islandora_markup_editor_islandora_xml_form_builder_forms() {
  $module_path = drupal_get_path('module', 'islandora_markup_editor');
  return array(
    'Markup Editor MODS form' => array(
      'form_file' => "$module_path/xml/islandora_markup_editor_form_mods.xml",
    ),
  );
}

/**
 * Implements hook_islandora_content_model_forms_form_associations().
 */
function islandora_markup_editor_islandora_content_model_forms_form_associations() {
  return array(
    'islandora_markup_editor_mods_form' => array(
      'content_model' => 'islandora:markupEditorCModel',
      'form_name' => 'Markup Editor MODS form',
      'dsid' => 'MODS',
      'title_field' => array('titleInfo', 'title'),
      'transform' => 'mods_to_dc.xsl',
      'template' => FALSE,
    ),
  );
}

/**
 * Implements hook_theme().
 */
function islandora_markup_editor_theme($existing, $type, $theme, $path) {
  return array(
    'islandora_markup_editor' => array(
      'template' => 'theme/islandora-markup-editor-plain',
      'pattern' => 'islandora_markup_editor__',
      'variables' => array('islandora_object' => NULL),
    ),
  );
}

/**
 * Implements hook_preproccess().
 *
 * When theming this from another module, set the
 * flag '$variables['custom_js']' to TRUE, and supply
 * your own .js init scripts via drupal_add_js in the
 * other modules preprocess function. See
 * islandora_critical_edition_preprocess_islandora_critical_edition()
 * for an example implementation.
 */
function islandora_markup_editor_preprocess_islandora_markup_editor(&$variables) {
  global $base_url;
  global $user;

  module_load_include('inc', 'islandora_markup_editor', 'includes/utilities');
  module_load_include('inc', 'islandora_paged_content', 'includes/utilities');
  module_load_include('inc', 'php_lib', 'DOMHelpers');

  $islandora_markup_editor_module_path = drupal_get_path('module', 'islandora_markup_editor');

  dom_document_pretty_print_include_files();

  $view = islandora_object_access_callback(ISLANDORA_VIEW_OBJECTS, $variables['islandora_object']);
  $view_edit = islandora_object_access_callback(ISLANDORA_CRITICAL_EDITION_EDIT_WITH_CWRC_WRITER, $variables['islandora_object']);
  $validate_path = variable_get('islandora_critical_edition_validate_url', '/validator/validate.html');

  drupal_add_js($islandora_markup_editor_module_path . "/CWRC-Writer/src/js/lib/require/require.js");

  // Allow other preprocessors to specify which dsid has the target data.
  // Construct available schemas.
  $doc_process_instructions = islandora_markup_editor_fetch_tei_processing_instruction($variables['islandora_object']);
  // This is silly. We need to override the default tei schema with our own.
  $schema_object = array();
  $schema_object['schemas']['tei'] = array(
    'cssUrl' => file_create_url("$islandora_markup_editor_module_path/CWRC-Writer/src/css/tei_converted.css"),
    'name' => 'tei',
    'url' => $doc_process_instructions['href'],
  );
  drupal_add_js(array('islandora_markup_editor' => array('can_edit' => $view_edit)), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('can_view' => $view)), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('module_edit_base' => $islandora_markup_editor_module_path)), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('entities_search_callback' => url('islandora/entities/search'))), 'setting');

  drupal_add_js(array('islandora_markup_editor' => array('schema_object' => $schema_object)), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('page_setup' => "islandora/markupeditor/setup/")), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('page_pid' => $variables['islandora_object']->id)), 'setting');
  drupal_add_js(array('islandora_markup_editor' => array('validate_path' => $validate_path)), 'setting');

  // Fix to support legacy cwrc-writer. (Old Dialogs used this)
  drupal_add_js(array('islandora_critical_edition' => array('module_edit_base' => $islandora_markup_editor_module_path)), 'setting');
  drupal_add_js(array('islandora_critical_edition' => array('module_base' => $islandora_markup_editor_module_path)), 'setting');


  drupal_add_js($islandora_markup_editor_module_path . '/CWRC-Writer/src/js/config.js');
  drupal_add_js($islandora_markup_editor_module_path . '/CWRC-Writer/src/js/lib/require/require.js');
  drupal_add_js($islandora_markup_editor_module_path . '/CWRC-Writer/src/js/layout.js');

  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/css/editor.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/css/style.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/css/islandora_style.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/css/layout-default-latest.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/js/lib/snippet/jquery.snippet.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/smoothness/jquery-ui-1.10.4.custom.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/js/lib/bootstrap/bootstrap.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/js/cwrcDialogs/css/datepicker.css");
  drupal_add_css($islandora_markup_editor_module_path . "/CWRC-Writer/src/js/cwrcDialogs/css/cD.css");


  islandora_markup_editor_add_files_from_dir($islandora_markup_editor_module_path . "/css", "css");

  $custom_js = isset($variables['custom_js']) ? $variables['custom_js'] : $islandora_markup_editor_module_path . "/js";

  if ($custom_js !== TRUE) {
    islandora_markup_editor_add_files_from_dir($custom_js);
  }
}

/**
 * Menu callback to provide setup info for the cwrc-writer/viewer.
 *
 * @param AbstractObject $fedora_object
 *   Fedora object to provide setup for.
 */
function islandora_markup_editor_setup(AbstractObject $fedora_object) {
  global $user;
  module_load_include('inc', 'islandora_basic_collection', 'includes/utilities');
  module_load_include('inc', 'islandora_paged_content', 'includes/utilities');

  $stroke_width = variable_get('image_annotation_annotation_stroke_width', '1%');
  $pages = array();
  $results = array();
  $results['uid'] = $user->uid;
  $results['position'] = "1";
  $results['pages'] = $pages[0] = $fedora_object->id;
  $results['title'] = $fedora_object->label;
  $results['no_edit'] = FALSE;
  $results['page_count'] = 1;
  $results['islandora_anno_stroke_width'] = '1%';

  $place_entity_collection = variable_get('islandora_entities_places_collection', 'islandora:entity_collection');
  $results['create_entity_callbacks']['places'] = url('islandora/object/' . $place_entity_collection . '/manage/overview/ingest');
  $event_entity_collection = variable_get('islandora_entities_events_collection', 'islandora:entity_collection');
  $results['create_entity_callbacks']['events'] = url('islandora/object/' . $event_entity_collection . '/manage/overview/ingest');
  $organization_entity_collection = variable_get('islandora_entities_organizations_collection', 'islandora:entity_collection');
  $results['create_entity_callbacks']['organizations'] = url('islandora/object/' . $organization_entity_collection . '/manage/overview/ingest');
  $person_entity_collection = variable_get('islandora_entities_people_collection', 'islandora:entity_collection');
  $results['create_entity_callbacks']['people'] = url('islandora/object/' . $person_entity_collection . '/manage/overview/ingest');

  drupal_json_output($results);
}

/**
 * Implements hook_CMODEL_PID_islandora_view_object().
 */
function islandora_markup_editor_islandora_markupEditorCModel_islandora_view_object($object, $page_number, $page_size) {
  return theme('islandora_markup_editor', array('islandora_object' => $object));
}

/**
 * Implements hook_islandora_ingest_steps().
 */
function islandora_markup_editor_islandora_markupEditorCModel_islandora_ingest_steps() {
  return array(
    'islandora_tei_upload' => array(
      'weight' => 10,
      'type' => 'form',
      'form_id' => 'islandora_markup_editor_tei_upload_form',
      'module' => 'islandora_markup_editor',
      'file' => 'includes/tei_upload.form.inc',
    ),
  );
}
